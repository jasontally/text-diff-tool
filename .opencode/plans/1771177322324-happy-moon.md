# Plan: Fix Language Detection Issues

## Problem

The language detection system has 9 failing tests due to:
1. **Python detector too aggressive** - `#` comment pattern matches `#!` (shebangs), Java annotations
2. **Scoring threshold mismatch** - Source uses `score >= 1` but tests expect `score >= 2`
3. **Detector order issues** - Python runs before Bash, catches shell scripts

Current approach relies on regex heuristics, which is fragile.

## Research Findings

### CDN-Available Options (Zero Dependencies)

| Library | Languages | Approach | CDN Available |
|---------|-----------|----------|---------------|
| **detect-code-language** | 50+ | Regex heuristics | Yes (`esm.sh` or `jsdelivr`) |
| **highlight.js** | 192 | Auto-detection built-in | Yes (already in app) |
| **vscode-languagedetection** | 50+ | ML-based | Yes |

### Recommended Approach

**Use `highlight.js` auto-detection** - It's already integrated into the app for syntax highlighting and has:
- 192 languages supported
- Automatic language detection built-in
- Zero additional dependencies (already loaded)
- More robust than custom regex patterns

## Implementation Plan

### Step 1: Add highlight.js Language Detection Helper

**File:** `src/language-detect.js`

Create a new function that uses highlight.js for detection:

```javascript
import hljs from 'https://esm.sh/highlight.js@11.9.0';

export function detectLanguageWithHighlight(content, filename = '') {
  // Try auto-detection first
  const result = hljs.highlightAuto(content);
  if (result.language && result.confidence > 70) {
    return mapHighlightToLanguage(result.language);
  }
  
  // Fall back to extension-based
  return detectFromExtension(filename);
}

function mapHighlightToLanguage(hljsLang) {
  const map = {
    'javascript': 'javascript',
    'typescript': 'typescript',
    'python': 'python',
    'bash': 'bash',
    'shell': 'bash',
    // ... map highlight.js names to app names
  };
  return map[hljsLang] || 'text';
}
```

### Step 2: Update detectLanguage to Use highlight.js

**File:** `src/language-detect.js`

Modify `detectLanguage()` function to:
1. Try highlight.js auto-detection first
2. Fall back to extension-based detection
3. Use custom regex only as final fallback

### Step 3: Fix Test Mismatches

The test file has its own detector copy that differs from source. Need to:
1. Either update test file to match source expectations, OR
2. Make source and test use the same detector

### Step 4: Run Tests

```bash
npm test -- tests/language-content-detection.test.js
```

## Files to Modify

1. `src/language-detect.js` - Add highlight.js integration
2. `tests/language-content-detection.test.js` - May need updates to align expectations

## Verification

- All language detection tests pass
- Manual testing: Paste code snippets and verify correct detection
- Test edge cases: shell scripts, Java with annotations, single-line snippets
