# Plan: Fix Line 2&3 Classification (Moved vs Modified)

## Problem

Lines 2 and 3 are incorrectly classified as "moved" when they should be "modified":

**Current (incorrect) output:**
```
LEFT (Previous Version):
   1      function test() {
   2  <   const a = 1;  (moved to: const a = 10;)
   3  <   const b = 2;  (moved to: const a = 10;)
   4  <   return a + b;  (moved to: return a + b + c;)

RIGHT (Current Version):
   1      function test() {
   2  >   const a = 10;
   3  >   const b = 20;
   4  >   const c = 30;
   5  >   return a + b + c;
```

**Expected (correct) output:**
- Line 1: unchanged - `function test() {`
- Line 2: **modified** - `const a = 1;` → `const a = 10;` (NOT moved)
- Line 3: **modified** - `const b = 2;` → `const b = 20;` (NOT moved)
- Line 4 (left): **removed** - `return a + b;`
- Line 4 (right): **added** - `const c = 30;`
- Line 5 (right): **moved** - `return a + b + c;` (moved from line 4)

## Root Cause

The `potentialMoves` detection (around line 1400 in `src/diff-algorithms.js`) marks ANY line as a "potential move" if it has >= 50% similarity with ANY line in the new text, **regardless of position**.

This causes:
- `const a = 1;` (88% similar to `const a = 10;`) → marked as potential move
- `const b = 2;` (88% similar to `const b = 20;`) → marked as potential move
- `return a + b;` (87% similar to `return a + b + c;`) → marked as potential move

All three get skipped during pairing and classified as "moved", even though lines 2-3 stayed in the same relative position.

## Solution

Only mark a line as "potential move" if:
1. Similar line exists in new text (>= 50% similarity), AND
2. The similar line is at a **significantly different position** (shift >= 2 lines)

This uses existing logic from `detectMovesInUnchangedLines` which already has `MIN_POSITION_SHIFT = 2`.

## Implementation Steps

### Step 1: Add line number tracking to identifyChangeBlocks

**File:** `src/diff-algorithms.js`

**Current code (lines ~631-687):** `identifyChangeBlocks` creates entries with:
```javascript
{
  line: line,
  index: i,           // diff entry index
  lineIndex: lineOffset, // offset within multi-line entry
  originalEntry: change.value
}
```

**Change:** Add `lineNumber` to track actual line position:
```javascript
{
  line: line,
  index: i,
  lineIndex: lineOffset,
  lineNumber: /* calculate actual line number */,
  originalEntry: change.value
}
```

### Step 2: Modify potentialMoves detection with position check

**File:** `src/diff-algorithms.js`

**Location:** Around line 1400-1450

**Current logic:**
```javascript
if (similarity >= moveThreshold) {
  existsInNew = true;  // Mark as potential move
  break;
}
```

**New logic:**
```javascript
if (similarity >= moveThreshold) {
  // Only mark as potential move if position shifted significantly
  // Get line numbers for comparison
  const oldLineNum = removed.lineNumber;
  const newLineNum = findLineNumberInText(newLine, newText);
  
  if (Math.abs(newLineNum - oldLineNum) >= 2) {
    existsInNew = true;  // Position shifted - it's a move
  }
  // Otherwise, position didn't shift much - it's a modification, not a move
  break;
}
```

### Step 3: Helper function to find line number in text

Add a simple helper function to find the line number of a string in text:
```javascript
function findLineNumberInText(targetLine, text) {
  const lines = text.split('\n');
  for (let i = 0; i < lines.length; i++) {
    if (lines[i].includes(targetLine) || targetLine.includes(lines[i].trim())) {
      return i;
    }
  }
  return -1;
}
```

## Full Test Code

Run this to verify the fix:

```javascript
import { diffLines, diffWords, diffChars } from 'diff';
import { detectModifiedLines } from './src/diff-algorithms.js';

const oldText = `function test() {
  const a = 1;
  const b = 2;
  return a + b;
}`;

const newText = `function test() {
  const a = 10;
  const b = 20;
  const c = 30;
  return a + b + c;
}`;

console.log('=== INPUT ===');
console.log('LEFT (Old):');
oldText.split('\n').forEach((l,i) => console.log(`  ${i+1}: ${l}`));
console.log('\nRIGHT (New):');
newText.split('\n').forEach((l,i) => console.log(`  ${i+1}: ${l}`));

const rawDiff = diffLines(oldText, newText);
const classified = await detectModifiedLines(
  rawDiff,
  diffWords,
  diffChars,
  { detectMoves: true },
  oldText,
  newText
);

console.log('\n=== OUTPUT ===');
console.log('\nLEFT:');
classified.forEach((entry, idx) => {
  const type = entry.classification;
  if (type === 'unchanged') {
    entry.value.split('\n').forEach((line, i) => {
      if (line.trim()) console.log(`  ${String(classified.slice(0,idx).reduce((s,c) => s + (c.classification==='unchanged'?c.value.split('\n').length:0), 0) + i + 1).padStart(3)}      ${line}`);
    });
  } else if (type === 'moved' || type === 'removed') {
    entry.value.split('\n').forEach((line, i) => {
      if (line.trim()) {
        const symbol = type === 'moved' ? '<' : '-';
        console.log(`  ${String('?').padStart(3)}  ${symbol}   ${line}`);
      }
    });
  }
});

console.log('\nRIGHT:');
// Similar output for right side...
```

## Expected Results After Fix

| Left Line | Right Line | Classification | Notes |
|-----------|------------|-----------------|-------|
| 1: `function test() {` | 1: `function test() {` | unchanged | No change |
| 2: `const a = 1;` | 2: `const a = 10;` | **modified** | Word diff: `1`→`10` |
| 3: `const b = 2;` | 3: `const b = 20;` | **modified** | Word diff: `2`→`20` |
| 4: `return a + b;` | - | **removed** | Exists in new at different position |
| - | 4: `const c = 30;` | **added** | New line |
| - | 5: `return a + b + c;` | **moved** | Moved from left line 4 |

## Verification Commands

```bash
# Run diff tests
npm test -- tests/diff.test.js

# Run all tests
npm test

# Run manual test
cd /Users/jtally/diff && node --experimental-vm-modules -e "..." 
```

## Files to Modify

1. **`src/diff-algorithms.js`** - Main changes:
   - `identifyChangeBlocks` function - add lineNumber tracking
   - `detectModifiedLines` function - modify potentialMoves detection with position check
   - Add helper function `findLineNumberInText`

2. **`tests/diff.test.js`** - May need to update if thresholds changed (unlikely)

## Constraints

- Keep changes minimal and simple
- Reuse existing `MIN_POSITION_SHIFT = 2` logic
- Don't break existing move detection (lines that truly move should still be detected)
- Maintain backward compatibility
