# Plan: Converged Move Detection System

## Problem

Currently there are THREE separate move detection systems that don't work well together:

1. **potentialMoves** - Pre-filters before pairing (checks if similar line exists elsewhere with position shift)
2. **detectMovesInUnchangedLines** - Finds "virtual" blocks from unchanged-but-shifted content
3. **detectBlockMovesFast** - Hash-based block move detection

With `MIN_POSITION_SHIFT = 1`:
- `potentialMoves` correctly identifies 1-line shifts
- But `detectBlockMovesFast` ALSO runs and creates conflicts
- Result: Incorrect classifications (lines marked as "moved" when they should be "modified")

## Solution: Unified Move Detection

Remove the redundancy by consolidating into ONE system:

### Approach

1. **Keep only `detectBlockMovesFast`** as the single source of truth for move detection
   - It handles single lines, multi-line blocks, and cross-block moves
   - Add parameter to enable 1-line shift detection (currently requires 2+ line shifts)

2. **Remove `potentialMoves` pre-filter** 
   - It's redundant with detectBlockMovesFast
   - Causes the conflict when both detect the same line differently

3. **Simplify final classification**
   - Just check if detectBlockMovesFast found a move
   - No need for potentialMoves check

## Implementation Steps

### Step 1: Modify detectBlockMovesFast to handle 1-line shifts

**File:** `src/block-move-detector.js`

Add parameter to detectBlockMovesFast to lower position shift threshold to 1:
- Current: Requires 2+ lines shift (MIN_POSITION_SHIFT = 2)
- Change: Make configurable, default to 1

### Step 2: Remove potentialMoves pre-filter logic

**File:** `src/diff-algorithms.js`

Remove or simplify the potentialMoves code:
- Lines ~1425-1495: Remove the entire potentialMoves creation block
- Lines ~1111-1165: Remove the potentialMoves check in findOptimalPairings
- This eliminates the duplicate detection and conflict

### Step 3: Simplify final classification

**File:** `src/diff-algorithms.js`

Simplify lines ~1578-1689:
- Remove the `potentialMoves.has()` check
- Only check `moves.has(index)` from detectBlockMovesFast

### Step 4: Update MIN_POSITION_SHIFT

**File:** `src/diff-algorithms.js`

Change line ~1426:
```javascript
const MIN_POSITION_SHIFT = 1;  // Was 2
```

## Files to Modify

1. `src/block-move-detector.js` - Add 1-line shift support to detectBlockMovesFast
2. `src/diff-algorithms.js` - Remove potentialMoves, simplify classification

## Verification

Test with these cases:
```javascript
// Case 1: Lines stay in same position - should be MODIFIED
const oldText = `function test() {
  const a = 1;
  const b = 2;
  return a + b;
}`;

const newText = `function test() {
  const a = 10;
  const b = 20;
  const c = 30;
  return a + b + c;
}`;
// Expected: 3 modified, 0 moved

// Case 2: Line moves 1 position - should be MOVED  
const oldText2 = `aaa\nbbb\nccc`;
const newText2 = `aaa\nccc\nbbb`;
// Expected: bbb moved from position 1 to 2

// Case 3: Multiple lines move together - should be BLOCK-MOVED
const oldText3 = `line 1\nline 2\nline 3`;
const newText3 = `line 1\nline 3\nline 2`;
// Expected: line 2 and line 3 swapped = block-moved
```

Run tests:
```bash
npm test -- tests/diff.test.js
```
