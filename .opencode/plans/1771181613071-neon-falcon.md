# Plan: Fix Language Detection Using highlight.js CDN

## Problem Analysis

The language detection has 9 failing tests due to fragile regex patterns:
1. Python detector too aggressive - catches shebangs and Java annotations
2. Detector order issues - Python runs before Bash
3. JavaScript/Java confusion with single patterns

## Recommended Solution: Use highlight.js Auto-Detection

**Add highlight.js via CDN** as the primary detection method - it's already available and more robust than regex heuristics.

## Implementation Steps

### Step 1: Add highlight.js import to src/language-detect.js

```javascript
import hljs from 'https://esm.sh/highlight.js@11.9.0';
```

### Step 2: Create highlight.js-based detection function

Add function to use `hljs.highlightAuto()` for detection:
- Get confidence score from auto-detection
- Map highlight.js language names to app's language identifiers
- Set confidence threshold (e.g., 70%)

### Step 3: Update detectLanguage to use highlight.js first

```javascript
export function detectLanguage(filename = '', content = '') {
  // Method 1: File extension (fastest)
  if (filename) {
    const ext = getFileExtension(filename);
    if (ext) {
      const lang = EXTENSION_MAP[ext.toLowerCase()];
      if (lang && DETECTABLE_LANGUAGES.includes(lang)) {
        return lang;
      }
    }
  }

  // Method 2: highlight.js auto-detection
  if (content && content.trim().length > 0) {
    const result = hljs.highlightAuto(content);
    if (result.language && result.confidence > 70) {
      const mapped = mapHighlightToLanguage(result.language);
      if (mapped && DETECTABLE_LANGUAGES.includes(mapped)) {
        return mapped;
      }
    }
  }

  // Method 3: Regex fallback (minimal)
  // ... existing CONTENT_DETECTORS as last resort

  return null;
}
```

### Step 4: Add language mapping function

```javascript
function mapHighlightToLanguage(hljsLang) {
  const map = {
    'javascript': 'javascript',
    'typescript': 'typescript',
    'python': 'python',
    'bash': 'bash',
    'shell': 'bash',
    'go': 'go',
    'rust': 'rust',
    'java': 'java',
    'json': 'json',
    'html': 'html',
    'css': 'css',
    'yaml': 'yaml',
    'xml': 'xml',
  };
  return map[hljsLang] || null;
}
```

### Step 5: Run tests

```bash
npm test -- tests/language-content-detection.test.js
```

## Files to Modify

1. `src/language-detect.js` - Add highlight.js integration

## Verification

- All 87 language detection tests pass
- Manual testing: Paste code snippets and verify correct detection
- Edge cases: shell scripts, Java annotations, single-line snippets
