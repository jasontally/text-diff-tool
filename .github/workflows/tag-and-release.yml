name: Tag and Release on Main

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'VERSION'
      - '*.md'
      - '.github/**'

jobs:
  tag-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Get current version
      id: get_version
      run: |
        CURRENT_VERSION="$(cat VERSION)"
        echo "CURRENT_VERSION=$CURRENT_VERSION" >> "$GITHUB_OUTPUT"
        echo "current_version=$CURRENT_VERSION"
    
    - name: Check if tag exists
      id: check_tag
      run: |
        CURRENT_VERSION="${{ steps.get_version.outputs.CURRENT_VERSION }}"
        if git rev-parse "v${CURRENT_VERSION}" >/dev/null 2>&1; then
          echo "TAG_EXISTS=true" >> "$GITHUB_OUTPUT"
          echo "tag_exists=true"
        else
          echo "TAG_EXISTS=false" >> "$GITHUB_OUTPUT"
          echo "tag_exists=false"
        fi
    
    - name: Increment version
      if: steps.check_tag.outputs.TAG_EXISTS == 'true'
      id: increment
      run: |
        NEW_VERSION="$(node scripts/version.js --increment-patch)"
        echo "NEW_VERSION=$NEW_VERSION" >> "$GITHUB_OUTPUT"
        echo "new_version=$NEW_VERSION"
        
        # Commit the version bump
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add VERSION index.html README.md package.json
        git commit -m "chore: bump version to ${NEW_VERSION} [skip ci]"
        git push
    
    - name: Create tag
      id: create_tag
      run: |
        if [ "${{ steps.check_tag.outputs.TAG_EXISTS }}" == "true" ]; then
          VERSION="${{ steps.increment.outputs.NEW_VERSION }}"
        else
          VERSION="${{ steps.get_version.outputs.CURRENT_VERSION }}"
        fi
        
        git tag "v${VERSION}"
        git push origin "v${VERSION}"
        echo "VERSION=$VERSION" >> "$GITHUB_OUTPUT"
        echo "version=$VERSION"
    
    - name: Generate release notes
      id: release_notes
      run: |
        VERSION="${{ steps.create_tag.outputs.VERSION }}"
        
        # Get the previous tag
        PREVIOUS_TAG="$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")"
        
        if [ -z "$PREVIOUS_TAG" ]; then
          # No previous tag, use all commits
          COMMITS="$(git log --pretty=format:"- %s (%h)" --no-merges)"
        else
          # Get commits between tags
          COMMITS="$(git log --pretty=format:"- %s (%h)" --no-merges "${PREVIOUS_TAG}..HEAD")"
        fi
        
        # Build release notes file using grouping
        {
          echo "## Changes in v${VERSION}"
          echo ""
          echo "${COMMITS}"
          echo ""
          echo "---"
          echo ""
          if [ -n "$PREVIOUS_TAG" ]; then
            echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREVIOUS_TAG}...v${VERSION}"
          fi
        } > release_notes.md
    
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ steps.create_tag.outputs.VERSION }}
        name: v${{ steps.create_tag.outputs.VERSION }}
        body_path: release_notes.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
